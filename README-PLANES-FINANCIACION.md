# Sistema de Planes de Financiación con Priorización

## Descripción

Este sistema implementa una lógica de priorización para los planes de financiación de productos:

1. **Planes Específicos** (`productos_planes`): Prioridad más alta
2. **Planes por Defecto** (`productos_planes_default`): Prioridad media
3. **Todos los Planes Activos**: Fallback si no hay configuraciones específicas

## Estructura de Tablas

### Tabla: `productos_planes_default`
```sql
CREATE TABLE productos_planes_default (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    fk_id_producto BIGINT NOT NULL,
    fk_id_plan BIGINT NOT NULL,
    activo BOOLEAN NOT NULL DEFAULT true,
    CONSTRAINT productos_planes_default_pkey PRIMARY KEY (id),
    CONSTRAINT productos_planes_default_fk_id_producto_fkey FOREIGN KEY (fk_id_producto) REFERENCES productos(id) ON DELETE CASCADE,
    CONSTRAINT productos_planes_default_fk_id_plan_fkey FOREIGN KEY (fk_id_plan) REFERENCES planes_financiacion(id) ON DELETE CASCADE,
    CONSTRAINT productos_planes_default_unique UNIQUE (fk_id_producto, fk_id_plan)
);
```

## Implementación

### 1. Crear la tabla y estructura
Ejecuta el script: `database/create-productos-planes-default.sql`

### 2. Poblar con datos existentes
Ejecuta el script: `database/populate-productos-planes-default.sql`

### 3. Configurar trigger automático
El trigger se crea automáticamente y asocia nuevos productos con todos los planes activos.

## Lógica de Priorización

### Función: `getPlanesProducto(productoId)`

1. **Buscar planes específicos** en `productos_planes`
   - Si encuentra planes específicos → los usa
   - Si no encuentra → continúa al paso 2

2. **Buscar planes por defecto** en `productos_planes_default`
   - Si encuentra planes por defecto → los usa
   - Si no encuentra → continúa al paso 3

3. **Usar todos los planes activos** como fallback
   - Obtiene todos los planes de `planes_financiacion` donde `activo = true`

## Uso en Componentes

### ProductCard
```tsx
<FinancingPlans productoId={product.id} precio={product.precio} />
```

### ProductPage
```tsx
<FinancingPlans productoId={product.id} precio={product.precio} showDebug={true} />
```

## Funciones Disponibles

### `getPlanesProducto(productoId: string)`
Obtiene los planes de financiación para un producto con priorización.

### `getTipoPlanesProducto(productoId: string)`
Retorna el tipo de planes que tiene el producto:
- `'especificos'`: Tiene planes en `productos_planes`
- `'default'`: Tiene planes en `productos_planes_default`
- `'todos'`: Usa todos los planes activos
- `'ninguno'`: No tiene planes disponibles

### `getPlanesFinanciacion()`
Obtiene todos los planes de financiación activos.

## Configuración de Productos Especiales

Para productos que necesitan planes específicos:

1. **Insertar en `productos_planes`**:
```sql
INSERT INTO productos_planes (fk_id_producto, fk_id_plan, activo) VALUES
(1, 1, true),  -- Producto 1 con Plan 1
(1, 2, true);  -- Producto 1 con Plan 2
```

2. **Los planes específicos tendrán prioridad** sobre los planes por defecto.

## Debug y Monitoreo

### Habilitar información de debug:
```tsx
<FinancingPlans productoId={product.id} precio={product.precio} showDebug={true} />
```

### Logs en consola:
- Muestra qué tipo de planes se están usando
- Cantidad de planes encontrados
- Información detallada del proceso de búsqueda

## Ventajas del Sistema

1. **Flexibilidad**: Permite configuraciones específicas por producto
2. **Automatización**: Los nuevos productos se asocian automáticamente
3. **Fallback**: Siempre hay planes disponibles
4. **Escalabilidad**: Fácil de mantener y extender
5. **Debug**: Información clara sobre qué planes se están usando

## Mantenimiento

### Agregar nuevos planes de financiación:
1. Insertar en `planes_financiacion`
2. Los productos existentes se asociarán automáticamente (si usan planes por defecto)

### Agregar nuevos productos:
1. Insertar en `productos`
2. Se asociarán automáticamente con todos los planes activos

### Configurar productos especiales:
1. Insertar en `productos_planes` con los planes específicos
2. Estos tendrán prioridad sobre los planes por defecto
