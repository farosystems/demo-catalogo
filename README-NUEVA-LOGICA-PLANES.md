# Nueva L√≥gica de Planes de Financiaci√≥n

## Descripci√≥n

Sistema actualizado de planes de financiaci√≥n con l√≥gica de priorizaci√≥n basada en categor√≠as y configuraci√≥n espec√≠fica por producto.

## Nueva L√≥gica de Priorizaci√≥n

### 1. **Planes Especiales** (Prioridad m√°s alta)
- **Tabla**: `productos_planes`
- **Configuraci√≥n**: `aplicar_planes_especiales = true`
- **Comportamiento**: Planes asociados manualmente al producto
- **Uso**: Productos con configuraciones espec√≠ficas

### 2. **Planes Generales** (Prioridad media)
- **Tabla**: `productos_planes_default`
- **Configuraci√≥n**: `aplicar_todos_planes = true`
- **Comportamiento**: Solo planes que NO tienen categor√≠as asociadas
- **Uso**: Productos que aplican a todos los planes generales

### 3. **Planes por Categor√≠a** (Prioridad baja)
- **Tabla**: `plan_categoria`
- **Configuraci√≥n**: `aplicar_planes_categoria = true`
- **Comportamiento**: Planes asociados a la categor√≠a del producto
- **Uso**: Productos que aplican a planes de su categor√≠a

### 4. **Fallback** (√öltimo recurso)
- **Tabla**: `planes_financiacion`
- **Comportamiento**: Todos los planes activos sin categor√≠as
- **Uso**: Cuando no hay otras configuraciones

## Nuevas Tablas y Campos

### Tabla: `plan_categoria`
```sql
CREATE TABLE plan_categoria (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    fk_id_plan BIGINT NOT NULL,
    fk_id_categoria BIGINT NOT NULL,
    activo BOOLEAN NOT NULL DEFAULT true,
    CONSTRAINT plan_categoria_pkey PRIMARY KEY (id),
    CONSTRAINT plan_categoria_fk_id_plan_fkey FOREIGN KEY (fk_id_plan) REFERENCES planes_financiacion(id) ON DELETE CASCADE,
    CONSTRAINT plan_categoria_fk_id_categoria_fkey FOREIGN KEY (fk_id_categoria) REFERENCES categoria(id) ON DELETE CASCADE,
    CONSTRAINT plan_categoria_unique UNIQUE (fk_id_plan, fk_id_categoria)
);
```

### Campos en `productos`
```sql
ALTER TABLE productos 
ADD COLUMN aplicar_todos_planes BOOLEAN DEFAULT false,
ADD COLUMN aplicar_planes_categoria BOOLEAN DEFAULT false,
ADD COLUMN aplicar_planes_especiales BOOLEAN DEFAULT false;
```

## Implementaci√≥n

### 1. Crear la tabla plan_categoria
```sql
-- Ejecutar: database/create-plan-categoria-table.sql
```

### 2. Agregar campos de configuraci√≥n a productos
```sql
-- Ejecutar: database/add-producto-config-fields.sql
```

### 3. Insertar datos de ejemplo
```sql
-- Ejecutar: database/insert-plan-categoria-sample.sql
```

## Configuraci√≥n de Productos

### Producto con Planes Generales
```sql
UPDATE productos 
SET aplicar_todos_planes = true
WHERE id = 1;
```

### Producto con Planes de Categor√≠a
```sql
UPDATE productos 
SET aplicar_planes_categoria = true
WHERE id = 2;
```

### Producto con Planes Especiales
```sql
UPDATE productos 
SET aplicar_planes_especiales = true
WHERE id = 3;
```

## Configuraci√≥n de Planes por Categor√≠a

### Asociar Plan a Categor√≠a
```sql
INSERT INTO plan_categoria (fk_id_plan, fk_id_categoria, activo) VALUES
(1, 1, true);  -- Plan 1 con categor√≠a Lavarropas
```

### Plan con M√∫ltiples Categor√≠as
```sql
INSERT INTO plan_categoria (fk_id_plan, fk_id_categoria, activo) VALUES
(3, 1, true),  -- Plan 3 con categor√≠a Lavarropas
(3, 2, true);  -- Plan 3 con categor√≠a Heladeras
```

## Funciones Actualizadas

### `getPlanesProducto(productoId: string)`
Nueva l√≥gica de priorizaci√≥n:
1. Verifica configuraci√≥n del producto
2. Busca planes especiales si `aplicar_planes_especiales = true`
3. Busca planes generales si `aplicar_todos_planes = true`
4. Busca planes de categor√≠a si `aplicar_planes_categoria = true`
5. Fallback a planes sin categor√≠as

### `getTipoPlanesProducto(productoId: string)`
Retorna el tipo de planes que tiene el producto:
- `'especiales'`: Planes en `productos_planes`
- `'default_sin_categoria'`: Planes en `productos_planes_default` (sin categor√≠as)
- `'categoria'`: Planes de la categor√≠a del producto
- `'fallback'`: Planes sin categor√≠as como fallback
- `'ninguno'`: No tiene planes disponibles

## Casos de Uso

### Caso 1: Producto General
- **Configuraci√≥n**: `aplicar_todos_planes = true`
- **Resultado**: Muestra todos los planes que NO tienen categor√≠as
- **Ejemplo**: Productos que aplican a planes generales

### Caso 2: Producto por Categor√≠a
- **Configuraci√≥n**: `aplicar_planes_categoria = true`
- **Resultado**: Muestra planes asociados a su categor√≠a
- **Ejemplo**: Lavarropas que solo aplican a planes de electrodom√©sticos

### Caso 3: Producto Especial
- **Configuraci√≥n**: `aplicar_planes_especiales = true`
- **Resultado**: Muestra planes asociados manualmente
- **Ejemplo**: Productos con promociones espec√≠ficas

### Caso 4: Producto sin Configuraci√≥n
- **Configuraci√≥n**: Todos los booleanos en `false`
- **Resultado**: Usa fallback (planes sin categor√≠as)
- **Ejemplo**: Productos nuevos sin configuraci√≥n

## Debug y Monitoreo

### Habilitar informaci√≥n de debug:
```tsx
<FinancingPlans productoId={product.id} precio={product.precio} showDebug={true} />
```

### Logs en consola:
```
üîç getPlanesProducto: Configuraci√≥n del producto: {
  categoria: 1,
  todos_planes: true,
  planes_categoria: false,
  planes_especiales: false
}
üîç getPlanesProducto: Planes por defecto encontrados: 3
‚úÖ getPlanesProducto: Usando planes por defecto (sin categor√≠a): 2 planes
```

## Ventajas del Sistema

1. **Flexibilidad**: Configuraci√≥n espec√≠fica por producto
2. **Categorizaci√≥n**: Planes organizados por categor√≠as
3. **Priorizaci√≥n**: L√≥gica clara de qu√© planes mostrar
4. **Escalabilidad**: F√°cil agregar nuevas categor√≠as y planes
5. **Mantenibilidad**: Configuraci√≥n centralizada
6. **Debug**: Informaci√≥n clara sobre qu√© planes se usan

## Mantenimiento

### Agregar Nueva Categor√≠a
```sql
INSERT INTO categoria (descripcion) VALUES ('Nueva Categor√≠a');
```

### Asociar Plan a Categor√≠a
```sql
INSERT INTO plan_categoria (fk_id_plan, fk_id_categoria, activo) VALUES (1, 5, true);
```

### Configurar Producto
```sql
UPDATE productos 
SET aplicar_planes_categoria = true
WHERE id = 123;
```

### Verificar Configuraci√≥n
```sql
SELECT 
    id,
    descripcion,
    aplicar_todos_planes,
    aplicar_planes_categoria,
    aplicar_planes_especiales
FROM productos 
WHERE id = 123;
```
